<?php

namespace BookingBundle\Entity;

use AppBundle\Entity\BasePriceResumeRepository;
use AppBundle\Service\HelperService;

/**
 * BookingServiceRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class BookingServiceRepository extends BasePriceResumeRepository
{
    static protected $metadata = null;

    /**
     * Get field metadata
     * @param $field
     * @param $attribute
     * @param $metadata (uses this metadata instead of local metadata)
     * @param $context ('view'|'form'|'none')
     * @return null
     */
    static public function getFieldMetadata($field, $attribute, $metadata = null, $context = 'none')
    {
        if (!$metadata) {
            $metadata = self::getMetadata();
        }
        return self::getLocalFieldMetadata($field, $attribute, $metadata, $context);
    }

    /**
     * Get local metadata (it needs to be implemented by children to get static variable with local metadata from parent)
     * @return mixed
     */
    protected function getLocalMetadata()
    {
        return $this->getMetadata();
    }

    /**
     * Overrides parent
     * @return mixed
     */
    static function getMetadata()
    {
        // Process metadata only once
        if (self::$metadata) {
            return self::$metadata;
        }

        $parentMetadata = parent::getMetadata();
        //$localTable = lcfirst(substr(strrchr(get_called_class(), '\\'), 1, -10));

        $localMetadata = self::$metadata = self::processMetadata(array(
            'bookingObj' => array('label' => '', 'type' => 'object', 'acl' => 'read', 'typeDetail' => array(
                'table' => 'booking', 'bundle' => 'booking', 'type' => 'none')),
            'serviceObj' => array('label' => 'Service', 'type' => 'object', 'acl' => 'edit',
                'typeDetail' => array(
                    'table' => 'service', 'bundle' => 'services', 'type' => 'none'//, 'fieldInView' => 'name',
                    // The booking service form filed by the user, only can handle with RegularServices.
                    //'choices' => array('query' => 'getChoicesForBookingService') // Used the DataBox
                ),
                'form' => array('type' => 'hidden-entity')
            ),
            'vatCodeObj' => array('label' => 'VAT Code', 'type' => 'object', 'acl' => 'read', 'dependency' => 'serviceObj',
                'typeDetail' => array('table' => 'vatCode', 'bundle' => 'accounting', 'type' => 'none')
            ),
            'vatCode_percentage' => array('table' => 'vatCode', 'field' => 'percentage', 'label' => '', 'type' => 'percentage',
                'acl' => 'read', 'dependency' => 'vatCodeObj', 'form' => array('type' => 'none')),
            'vatCode_name' => array('table' => 'vatCode', 'field' => 'name', 'label' => 'VAT Code', 'type' => 'text',
                'acl' => 'read', 'dependency' => 'vatCodeObj', 'form' => array('type' => 'none')),
            'appIconObj' => array('table' => 'service', 'label' => 'nd',
                'type' => 'object', 'acl' => 'read', 'dependency' => 'serviceObj', 'typeDetail' => array(
                    'table' => 'app_icon', 'bundle' => 'sysadmin', 'type' => 'none')
            ),
            'icon' => array('table' => 'app_icon', 'label' => 'Icon', 'type' => 'icon',
                'acl' => 'read', 'dependency' => 'appIconObj'),
            'name' => array('table' => 'service', 'label' => 'Name', 'type' => 'text',
                'acl' => 'read', 'dependency' => 'serviceObj'),
            'type' => array('table' => 'service', 'label' => '', 'type' => 'fake',
                'acl' => 'read', 'dependency' => 'serviceObj', 'form' => array('type' => 'none')),
            'thumbnail' => array('table' => 'service', 'label' => 'Thumbnail', 'type' => 'img', 'acl' => 'read',
                'dependency' => 'serviceObj'),
            'startDate' => array('label' => 'Start Date', 'type' => 'date', 'acl' => 'read'),
            // Fake field to control the startDate in edit mode (can't be edited if is auto allot or auto availability)
            'startDateManual' => array('label' => 'Start Date', 'type' => 'date', 'acl' => 'edit',
                'view' => array(
                    'type' => 'none', 'typeDetail' => array(
                        'rules' => array(
                            array('expr' => 'max', 'value' => 'endDateManual', 'allowSkip' => false),
                            array('expr' => 'range', 'value' => 'availability', 'allowSkip' => true),
                        ),
                        'skipRulesControl' => '!isAutoAvailability'
                    )
                ),
                'form' => array('isMapped' => false)
            ),
            'endDate' => array('label' => 'End Date', 'type' => 'date', 'acl' => 'read'),
            // Fake field to control the endDate in edit mode (can't be edited if is auto allot or auto availability)
            'endDateManual' => array('label' => 'End Date', 'type' => 'date', 'acl' => 'edit',
                'view' => array(
                    'type' => 'none', 'typeDetail' => array(
                        'rules' => array(
                            array('expr' => 'min', 'value' => 'startDateManual', 'allowSkip' => false),
                            array('expr' => 'range', 'value' => 'availability', 'allowSkip' => true),
                        ),
                        'skipRulesControl' => '!isAutoAvailability'
                    )
                ),
                'form' => array('isMapped' => false)
            ),
            'durationDays' => array('label' => 'Duration', 'type' => 'number', 'acl' => 'read'),
            'quantity' => array('label' => 'Quantity', 'type' => 'number', 'acl' => 'read'),
            // Fake field to control the quantity in edit mode (can't be edited if is auto allot)
            'quantityManual' => array('label' => 'Quantity', 'type' => 'number', 'acl' => 'edit',
                'view' => array('type' => 'none'),
                'form' => array('isMapped' => false)
            ),
            // It's here for query builder (to get metadata about field)
            'allotTargetServiceObj' => array('label' => 'nd', 'type' => 'object', 'acl' => 'read',
                'typeDetail' => array(
                    'table' => 'service', 'bundle' => 'services', 'type' => 'none'
                )
            ),
            'confirmationStatus' => array('label' => 'Confirmation', 'type' => 'status', 'acl' => 'read'),
            // Fake field to skip the auto confirmation status
            'confirmationStatusManual' => array('field' => 'confirmationStatus', 'label' => 'Confirmation',
                'type' => 'enum', 'acl' => 'edit',
                'typeDetail' => array(
                    'type' => 'none', 'fieldInView' => 'confirmationStatus', 'choices' => array(
                        'value' => array(
                            '<span class="status -danger"></span>' => 'NO',
                            '<span class="status -warning"></span>' => 'PARTIAL',
                            '<span class="status -primary"></span>' => 'YES'
                        )
                    )
                ),
                'form' => array('type' => 'html-select', 'isMapped' => false),
                'view' => array('type' => 'none')
            ),
            'isEnabledAvailability' => array('table' => 'service', 'label' => '', 'type' => 'fake',
                'acl' => 'read', 'dependency' => 'serviceObj', 'form' => array('type' => 'none')),
            // To control the way how user handles with availability
            'isAutoAvailability' => array('label' => 'Auto Availability', 'type' => 'none', 'acl' => 'edit',
                'isRequired' => false,
                'form' => array('type' => 'boolean', 'isFakeField' => true) // Fake field defined in entity
            ),
            'isEnabledAllot' => array('table' => 'service', 'label' => '', 'type' => 'fake',
                'acl' => 'read', 'dependency' => 'serviceObj', 'form' => array('type' => 'none')),
            // To control the way how user handles with allot
            // (this is not a manual field, is saved in database to control allot)
            'isAutoAllot' => array('label' => 'Auto Allot', 'type' => 'boolean', 'acl' => 'edit'),
            'isEnabledPrice' => array('table' => 'service', 'label' => '', 'type' => 'fake',
                'acl' => 'read', 'dependency' => 'serviceObj', 'form' => array('type' => 'none')),
            // To control the way how user handles with price
            'isAutoPrice' => array('label' => 'Auto Price', 'type' => 'none', 'acl' => 'edit',
                'isRequired' => false,
                'form' => array('type' => 'boolean', 'isFakeField' => true) // Fake field defined in entity
            ),
            'description' => array('label' => 'Description', 'type' => 'text', 'acl' => 'edit'),
            'supplierObj' => array('label' => 'Supplier', 'type' => 'object', 'acl' => 'edit',
                'typeDetail' => array(
                    'table' => 'supplier', 'bundle' => 'entities', 'type' => 'none', 'fieldInView' => 'supplier_name'),
                'isRequired' => false,
                'form' => array('type' => 'auto-complete')
            ),
            'entityObj' => array('table' => 'supplier', 'field' => 'entityObj', 'label' => 'nd',
                'type' => 'object', 'acl' => 'read', 'dependency' => 'supplierObj', 'typeDetail' => array(
                    'table' => 'entity', 'tableAlias' => 'entity', 'bundle' => 'entities', 'type' => 'none')
            ),
            'supplier_name' => array('table' => 'entity', 'field' => 'name', 'label' => 'Supplier',
                'type' => 'text', 'acl' => 'read', 'dependency' => 'entityObj', 'form' => array('type' => 'none')),
            'reference' => array('label' => 'Reference', 'type' => 'text', 'acl' => 'edit'),
            // Check in the future if it's needed
            /*'groupingSubTotalSell' => array('label' => 'Group. Sell (no VAT)', 'type' => 'none', 'acl' => 'read'),
            'groupingTotalVatSell' => array('label' => 'Group. Sell VAT', 'type' => 'none', 'acl' => 'read'),
            'groupingTotalSell' => array('label' => 'Group. Total Sell', 'type' => 'monetary', 'acl' => 'read',
                'field' => '('.$localTable.'.groupingSubTotalSell + '.$localTable.'.groupingTotalVatSell)', 'table' => '',
                'attr' => array('readonly' => 'readonly'), 'isRequired' => false,
                'form' => array('type' => 'number', 'isMapped' => false),
                'normalizer' => array('method' => 'getGroupingTotalSell')
            ),*/
            'priority' => array('label' => 'Priority', 'type' => 'none', 'acl' => 'read'),
            // Handled by cancel action
            'isEnabled' => array('label' => 'Enabled', 'type' => 'boolean', 'acl' => 'read', 'form' => array('type' => 'none'))
        ));

        return self::$metadata = HelperService::pushIntoArray($parentMetadata, $localMetadata, 'id');
    }

    /**
     * Set totals to service booking (from booking service price objects)
     * @param $bookingServiceObj
     * @return mixed
     */
    public function setTotals($bookingServiceObj)
    {
        $localTable = $this->getLocalTable();

        ////////////////////////////////////
        // Booking Service Price
        ////////////////////////////////////////
        $options = array(
            'fields' => array(
                "SUM(CASE WHEN (bookingServicePrice.postingType = 'DEBIT') THEN bookingServicePrice.subTotalCost ELSE (bookingServicePrice.subTotalCost * -1) END) AS subTotalCost",
                "SUM(CASE WHEN (bookingServicePrice.postingType = 'DEBIT') THEN bookingServicePrice.subTotalSell ELSE (bookingServicePrice.subTotalSell * -1) END) AS subTotalSell",
                "SUM(CASE WHEN (bookingServicePrice.postingType = 'DEBIT') THEN bookingServicePrice.totalVatCost ELSE (bookingServicePrice.totalVatCost * -1) END) AS totalVatCost",
                "SUM(CASE WHEN (bookingServicePrice.postingType = 'DEBIT') THEN bookingServicePrice.totalVatSell ELSE (bookingServicePrice.totalVatSell * -1) END) AS totalVatSell"
            ),
            'criteria' => array(
                array(
                    'field' => 'id',
                    'expr' => 'eq',
                    'value' => $bookingServiceObj->getId()
                )
            )
        );

        $qb = $this->queryBuilder($options, false);

        $qb->innerJoin('BookingBundle\Entity\BookingServicePrice',
            'bookingServicePrice',
            'WITH',
            ('(bookingServicePrice.bookingServiceObj = ' . $localTable . '.id) AND (bookingServicePrice.isEnabled = 1)')
        );

        $totals = $this->executeQueryBuilder($qb);
        $totals = reset($totals); // First element of array

        // If the object belongs to a grouping service, then the object does not handles with sell values,
        // they are handled by grouping service
        if ($bookingServiceObj->getGroupingBookingServiceObj()) {
            $totals['subTotalSell'] = 0;
            $totals['totalVatSell'] = 0;
        } else {
            /////////////////////////////////////
            // Grouping Booking Service Price
            //////////////////////////////////////
            $options = array(
                'fields' => array(
                    "SUM(bookingService.subTotalSell) AS subTotalSell"
                ),
                'criteria' => array(
                    array(
                        'field' => 'isEnabled',
                        'expr' => 'eq',
                        'value' => true
                    ),
                    array(
                        'field' => 'groupingBookingServiceObj',
                        'expr' => 'eq',
                        'value' => $bookingServiceObj->getId()
                    )
                )
            );

            $qb = $this->queryBuilder($options);

            $groupingTotals = $this->executeQueryBuilder($qb);
            $groupingTotals = reset($groupingTotals); // First element of array

            $totals['subTotalSell'] += $groupingTotals['subTotalSell'];
            // Note: totalVatSell needs to be calculated again according with the
            // updated "subTotalSell" (from grouped services that can have other VAT code)
            $totals['totalVatSell'] = 0;
        }

        $bookingServiceObj->setSubTotalCost($totals['subTotalCost']);
        $bookingServiceObj->setSubTotalSell($totals['subTotalSell']);
        $bookingServiceObj->setTotalVatCost($totals['totalVatCost']);
        $bookingServiceObj->setTotalVatSell($totals['totalVatSell']);

        return $bookingServiceObj;
    }

    /**
     * Get busy allot by date
     * @param $serviceObj (object)
     * @param $date
     * @param $allotTargetServiceObj (target service object, to get allot of specific service (like packages))
     * @return mixed
     */
    public function getBusyAllotByDate($serviceObj, $date, $allotTargetServiceObj = null)
    {
        $localTable = $this->getLocalTable();

        // Fields
        $options['fields'] = array(
            "SUM(".$localTable.".quantity) AS busy"
        );

        // Criteria
        $options['criteria'] = array(
            array('field' => 'serviceObj', 'expr' => 'eq', 'value' => $serviceObj),
            array('field' => $date, 'expr' => 'rbetween', 'value' => array('startDate', 'endDate')),
            array('field' => 'isAutoAllot', 'expr' => 'eq', 'value' => 1),
            array('field' => 'confirmationStatus', 'expr' => 'eq', 'value' => 'YES'),
            array('field' => 'isEnabled', 'expr' => 'eq', 'value' => 1)
        );
        if ($allotTargetServiceObj) {
            // Specific allot for $targetServiceObj
            $options['criteria'][] = array('field' => 'allotTargetServiceObj', 'expr' => 'eq', 'value' => $allotTargetServiceObj);
        } else {
            // Regular allot
            $options['criteria'][] = array('field' => 'allotTargetServiceObj', 'expr' => 'isNull', 'value' => null);
        }

        // Get query builder
        $qb = $this->queryBuilder($options, false);

        // Get booking
        $qb->leftJoin($localTable.'.bookingObj',
            'booking',
            'WITH',
            'booking.isEnabled = 1'
        );

        $busyAllot = $this->executeQueryBuilder($qb);
        $busyAllot = reset($busyAllot); // Get first element
        return (empty($busyAllot['busy']) ? 0 : $busyAllot['busy']);
    }
}